---
# --- Node Exporter ---
- name: Download Node Exporter
  ansible.builtin.unarchive:
    src: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
    dest: "{{ monitor_bin_dir }}"
    remote_src: yes
    extra_opts: "--strip-components=1"
    creates: "{{ monitor_bin_dir }}/node_exporter"

- name: Create Node Exporter Service
  ansible.builtin.copy:
    dest: /etc/systemd/system/node_exporter.service
    content: |
      [Unit]
      Description=Node Exporter
      After=network.target
      [Service]
      User=root
      ExecStart={{ monitor_bin_dir }}/node_exporter
      [Install]
      WantedBy=multi-user.target
  notify: restart node_exporter

# --- Promtail ---
- name: Download Promtail
  ansible.builtin.unzip:
    src: "https://github.com/grafana/loki/releases/download/v{{ promtail_version }}/promtail-linux-amd64.zip"
    dest: "{{ monitor_bin_dir }}"
    remote_src: yes
    creates: "{{ monitor_bin_dir }}/promtail-linux-amd64"

- name: Rename Promtail binary
  ansible.builtin.command:
    cmd: mv {{ monitor_bin_dir }}/promtail-linux-amd64 {{ monitor_bin_dir }}/promtail
    creates: "{{ monitor_bin_dir }}/promtail"

- name: Configure Promtail
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ monitor_config_dir }}/promtail-config.yml"
  notify: restart promtail

- name: Create Promtail Service
  ansible.builtin.copy:
    dest: /etc/systemd/system/promtail.service
    content: |
      [Unit]
      Description=Promtail
      After=network.target
      [Service]
      User=root
      ExecStart={{ monitor_bin_dir }}/promtail -config.file={{ monitor_config_dir }}/promtail-config.yml
      [Install]
      WantedBy=multi-user.target
  notify: restart promtail

# --- Firewall ---
- name: Open Firewall Ports (Agent)
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - 9100/tcp  # Node Exporter
    - 9080/tcp  # Promtail (default)
