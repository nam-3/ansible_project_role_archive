global
    log 127.0.0.1 local0
    maxconn 4000
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout tunnel 1h

frontend web_frontend
    bind *:80
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_ws_path   path_beg /ws/
    use_backend ws_backend if is_websocket or is_ws_path
    default_backend web_backend

backend web_backend
    balance roundrobin
    cookie SERVERID insert indirect nocache
    option httpchk GET /api/public/settings
    http-check expect status 200
    {% for host in groups['web'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:80 check inter 3s fall 3 rise 2 cookie {{ host }}
    {% endfor %}

backend ws_backend
    balance roundrobin
    timeout tunnel 1h
    {% for host in groups['web'] %}
    server {{ host }}_ws {{ hostvars[host]['ansible_host'] }}:80
    {% endfor %}

listen stats
    bind *:9000
    stats enable
    stats uri /haproxy-stats
    stats refresh 10s
    stats auth admin:admin123
