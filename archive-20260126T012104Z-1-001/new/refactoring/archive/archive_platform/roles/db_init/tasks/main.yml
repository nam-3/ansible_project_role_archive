---
# ========================================
# DB Logic Initialization Role
# ========================================
# This role handles logic that requires a RUNNING database cluster.
# It MUST run after 'patroni' role.
# It runs only on the LEADER node.

# 0. DCS 노드 제외
- name: Check if node is DB node
  set_fact:
    is_db_node: "{{ 'dcs' not in inventory_hostname }}"
  tags: [db_init]

# 0.5 Wait for Cluster Leader Election (Global Check)
- name: Wait until a Leader is elected in the cluster
  uri:
    url: "http://{{ service_ip }}:8008/cluster"
    return_content: yes
  register: cluster_status
  until: "'\"role\": \"leader\"' in cluster_status.content"
  retries: 30
  delay: 5
  tags: [db_init]
  when: is_db_node

# 1. Wait for Patroni Leader (or Replica)
- name: Check node status (Leader=200, Replica=503)
  uri:
    url: "http://{{ service_ip }}:8008/leader"
    status_code: [200, 503]
  register: leader_check
  tags: [db_init]
  when: is_db_node

# 1.1 Debug - Check Status
- debug:
    msg: "Node {{ inventory_hostname }} status: {{ leader_check.status }}"
  tags: [db_init]
  when: is_db_node

# 2. Admin User (For App) - Only on Leader (200)
- name: Create or Update Admin User
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -c "
    DO \$$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'admin') THEN
        CREATE ROLE admin LOGIN PASSWORD 'Soldesk1.' CREATEDB CREATEROLE;
      END IF;
    END
    \$$;"
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200

# 3. CMP Database - Only on Leader (200)
# 3. CMP Database - Only on Leader (200)
- name: Check if 'cmp_db' exists
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname = 'cmp_db'"
  register: db_check
  changed_when: false
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200

- name: Create Application Database (cmp_db)
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -c "CREATE DATABASE cmp_db OWNER admin"
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200 and db_check.stdout != '1'
