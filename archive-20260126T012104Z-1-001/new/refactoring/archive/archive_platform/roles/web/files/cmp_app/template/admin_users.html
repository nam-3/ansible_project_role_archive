<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>H-CMP | User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* í…Œì´ë¸” í˜¸ë²„ íš¨ê³¼ */
        .table-row-hover:hover {
            background-color: #f8fafc;
            transition: background 0.2s;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <nav class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 font-black text-xl text-slate-800">
            <i data-lucide="user-check" class="text-blue-600"></i>
            <span>User Management</span>
        </div>
        <a href="/" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-blue-600 transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Console
        </a>
    </nav>

    <main class="max-w-7xl mx-auto p-8 fade-in">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">ì‚¬ìš©ì ê°€ì… ìŠ¹ì¸</h1>
                <p class="text-slate-500 text-sm mt-1">ì‹ ê·œ ê°€ì… ì‹ ì²­ìë¥¼ ê²€í† í•˜ê³  ìì› ì¿¼í„°ë¥¼ í• ë‹¹í•˜ì„¸ìš”.</p>
            </div>
            <div id="pending-badge"
                class="flex items-center gap-2 text-xs font-bold text-blue-600 bg-blue-50 px-4 py-2 rounded-full border border-blue-100">
                ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­: <span id="pending-count">0</span>ê±´
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200">
                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ì‹ ì²­ì ì •ë³´</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ì‹ ì²­ì¼ì‹œ</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ìƒíƒœ</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">ê´€ë¦¬
                        </th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <tr>
                        <td colspan="4" class="px-6 py-20 text-center text-slate-400 font-medium">
                            ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // ì•„ì´ì½˜ ì´ˆê¸°í™”
        lucide.createIcons();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë  ë¡œì§ ì˜ˆì‹œ
        // fetchPendingUsers(); 
    </script>
</body>

</html>

<script>
    async function loadPendingUsers() {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch('/api/admin/pending-users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            console.log("ğŸ” API ì‘ë‹µ ë°ì´í„°:", users);

            const list = document.getElementById('user-list');
            const count = document.getElementById('pending-count');

            if (!Array.isArray(users)) {
                count.innerText = "0";
                list.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-red-500 font-bold">ì—ëŸ¬: ${users.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</td></tr>`;
                return;
            }

            count.innerText = users.length;
            if (users.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-slate-400 font-bold italic">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            list.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-5">
                        <div class="font-bold text-slate-900">${u.full_name}</div>
                        <div class="text-xs text-slate-400">${u.username}</div>
                    </td>
                    <td class="px-6 py-5 text-sm text-slate-500">${new Date(u.created_at).toLocaleString()}</td>
                    <td class="px-6 py-5">
                        <span class="bg-amber-50 text-amber-600 px-2.5 py-1 rounded-md text-xs font-black uppercase border border-amber-100 italic">Pending</span>
                    </td>
                    <td class="px-6 py-5 text-right">
                        <button onclick="approveUser('${u.username}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-sm">ìŠ¹ì¸í•˜ê¸°</button>
                        <button onclick="rejectUser('${u.username}')" class="ml-2 bg-white text-slate-400 px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 hover:text-red-600 hover:border-red-200 transition">ê±°ì ˆ</button>
                    </td>
                </tr>
            `).join('');

            // ì•„ì´ì½˜ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            if (window.lucide) lucide.createIcons();

        } catch (err) {
            console.error("âŒ Fetch ì—ëŸ¬:", err);
        }
    }

    async function approveUser(username) {
        if (!confirm(`${username} ì‚¬ìš©ìë¥¼ ìŠ¹ì¸í•˜ê³  ê¸°ë³¸ ìì›ì„ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        const token = localStorage.getItem('token');
        const res = await fetch(`/api/admin/approve-user/${username}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            alert("ì‚¬ìš©ì ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadPendingUsers();
        }
    }
    loadPendingUsers();
</script>