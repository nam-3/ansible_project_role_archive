---
# ========================================
# DB Logic Initialization Role
# ========================================
# This role handles logic that requires a RUNNING database cluster.
# It MUST run after 'patroni' role.
# It runs only on the LEADER node.

# 0. DCS 노드 제외
- name: Check if node is DB node
  set_fact:
    is_db_node: "{{ 'dcs' not in inventory_hostname }}"
  tags: [db_init]

# 1. Wait for Patroni Leader (or Replica)
- name: Wait for Patroni Leader (returns 200) or Replica (returns 503)
  uri:
    url: "http://{{ service_ip }}:8008/leader"
    status_code: [200, 503]
  register: leader_check
  until: leader_check.status in [200, 503]
  retries: 30
  delay: 5
  tags: [db_init]
  when: is_db_node

# 2. Replicator User (For HA) - Only on Leader (200)
- name: Create or Update Replicator User
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -c "
    DO \$$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'replicator') THEN
        CREATE ROLE replicator LOGIN PASSWORD 'replicator_password' REPLICATION;
      END IF;
    END
    \$$;"
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200

# 3. Admin User (For App) - Only on Leader (200)
- name: Create or Update Admin User
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -c "
    DO \$$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'admin') THEN
        CREATE ROLE admin LOGIN PASSWORD 'Soldesk1.' CREATEDB CREATEROLE;
      END IF;
    END
    \$$;"
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200

# 4. CMP Database - Only on Leader (200)
- name: Create Application Database (cmp_db)
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -h {{ service_ip }} -U postgres -d postgres -c "
    SELECT 'CREATE DATABASE cmp_db OWNER admin'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'cmp_db')\gexec"
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  tags: [db_init]
  when: is_db_node and leader_check.status == 200

# 5. Restart Cluster to Apply Verification
- name: Restart Patroni on all DB nodes (to sync replication)
  service:
    name: patroni
    state: restarted
  delegate_to: "{{ item }}"
  loop: "{{ groups['db_cluster'] }}"
  run_once: true
  tags: [db_init]
  when: is_db_node
