---
# 1. 바이너리 파일 복사 (Ansible Server -> Target Server)
# 1. 바이너리 파일 복사 (Ansible Server -> Target Server)
# 참고: 바이너리 파일이 'files/' 디렉토리에 있어야 합니다.

- name: Force Clean Etcd Data (If requested)
  file:
    path: /var/lib/etcd
    state: absent
  when: force_etcd_clean | default(false) | bool

- name: Check if etcd binaries exist locally
  stat:
    path: "{{ role_path }}/files/{{ item }}"
  register: binary_check
  with_items:
    - etcd
    - etcdctl
  delegate_to: localhost
  ignore_errors: true

- name: Copy ETCD binaries to /usr/local/bin
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
    owner: root
    group: root
  with_items:
    - etcd
    - etcdctl
  notify: restart etcd
  # 파일이 로컬에 없으면 실패할 수 있으므로, 실제 바이너리 위치를 확인하세요.

# 2. 필수 디렉토리 생성
- name: Create configuration and data directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - /var/lib/etcd
    - /etc/etcd

# 3. 설정 파일 배포
- name: Configure ETCD environment file
  template:
    src: etcd.conf.j2
    dest: /etc/etcd/etcd.conf
  notify: restart etcd

# 4. Systemd 서비스 파일 생성
- name: Create Systemd unit file
  template:
    src: etcd.service.j2
    dest: /etc/systemd/system/etcd.service
  notify: restart etcd

# 5. 방화벽 설정 (CentOS 9 firewalld)
- name: Open firewall ports for ETCD
  firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  with_items:
    - 2379/tcp
    - 2380/tcp
  ignore_errors: yes # firewalld가 안 켜져 있을 경우 무시

# 6. 서비스 시작
- name: Enable and Start ETCD service
  systemd:
    name: etcd
    state: started
    enabled: yes
    daemon_reload: yes
