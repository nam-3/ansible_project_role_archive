---
# -----------------------------------------------------------------
# 0. DCS 노드 판별 (이름에 'dcs'가 있으면 DB 설치 대상 아님)
# -----------------------------------------------------------------
- name: Check if node is DB node
  set_fact:
    is_db_node: "{{ 'dcs' not in inventory_hostname }}"
  tags: [always]

# -----------------------------------------------------------------
# 1. 리포지토리 설정 (DB 노드만)
# -----------------------------------------------------------------
- name: Enable CRB & Install EPEL
  block:
    - command: dnf config-manager --set-enabled crb
      ignore_errors: yes
    - dnf: name=epel-release state=present
    - command: dnf clean all
      changed_when: false
  when: is_db_node

- name: Install PostgreSQL RPM Repository
  dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ ansible_distribution_major_version }}-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present
    disable_gpg_check: yes
  when: is_db_node

- name: Disable default PostgreSQL module
  command: dnf -qy module disable postgresql
  changed_when: false
  ignore_errors: yes
  when: is_db_node

# -----------------------------------------------------------------
# 2. 패키지 설치 (DB 노드만)
# -----------------------------------------------------------------
- name: Install PostgreSQL & Dependencies
  shell: |
    dnf install -y postgresql{{ pg_version }}-server \
    postgresql{{ pg_version }}-contrib \
    postgresql{{ pg_version }}-devel \
    python3-pip python3-devel gcc watchdog \
    --nogpgcheck
  register: dnf_result
  changed_when: "'Nothing to do' not in dnf_result.stdout"
  when: is_db_node

# -----------------------------------------------------------------
# 3. [Path 해결] 심볼릭 링크 -> /usr/bin (DB 노드만)
# -----------------------------------------------------------------
- name: Symlink PostgreSQL binaries to /usr/bin
  file:
    src: "/usr/pgsql-{{ pg_version }}/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    state: link
    force: yes
  loop:
    - postgres
    - pg_ctl
    - initdb
    - pg_basebackup
    - psql
    - pg_config
  when: is_db_node

# -----------------------------------------------------------------
# 4. Patroni 설치 (DB 노드만)
# -----------------------------------------------------------------
- name: Upgrade pip build tools
  pip:
    name: [pip, setuptools, wheel]
    state: latest
    executable: pip3
  when: is_db_node

- name: Install Patroni via PIP (v3 support)
  pip:
    name:
      - "psycopg2==2.9.9"
      - "patroni[etcd3]"
    executable: pip3
  environment:
    PATH: "/usr/pgsql-{{ pg_version }}/bin:{{ ansible_env.PATH }}"
  when: is_db_node

# -----------------------------------------------------------------
# 5. 설정 및 서비스 (DB 노드만)
# -----------------------------------------------------------------
- name: Enable Watchdog service
  service: name=watchdog state=started enabled=yes
  when: is_db_node

- name: Disable default systemd postgresql service
  service:
    name: "postgresql-{{ pg_version }}"
    state: stopped
    enabled: no
  ignore_errors: yes
  when: is_db_node

- name: Create Patroni Config Directory
  file: path=/etc/patroni state=directory
  when: is_db_node

- name: Deploy Patroni Config
  template:
    src: patroni.yml.j2
    dest: /etc/patroni/patroni.yml
  when: is_db_node
  notify: Restart Patroni

- name: Deploy Patroni Service Unit
  template:
    src: patroni.service.j2
    dest: /etc/systemd/system/patroni.service
  when: is_db_node
  notify: Restart Patroni

- name: Start Patroni Service
  service:
    name: patroni
    state: started
    enabled: yes
  when: is_db_node

- name: Open firewall ports for PostgreSQL and Patroni
  firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - 5432/tcp
    - 8008/tcp
  when: is_db_node
  ignore_errors: yes

# -----------------------------------------------------------------
# 6. 사용자 및 DB 자동 생성 (Fail-safe)
# -----------------------------------------------------------------
- name: Create or Update Replicator User (Fail-safe)
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -U postgres -h 127.0.0.1 -c "DO \$$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'replicator') THEN CREATE ROLE replicator LOGIN PASSWORD 'replicator_password' REPLICATION; END IF; END \$$;" || true
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  register: replicator_create_result
  until: replicator_create_result.rc == 0
  retries: 20
  delay: 5
  ignore_errors: yes
  tags: [db_init]
  when: is_db_node

- name: Create or Update Admin User and Database (Fail-safe)
  shell: |
    /usr/pgsql-{{ pg_version }}/bin/psql -U postgres -h 127.0.0.1 -c "DO \$$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'admin') THEN CREATE ROLE admin LOGIN PASSWORD 'Soldesk1.' CREATEDB CREATEROLE; END IF; END \$$;"
    /usr/pgsql-{{ pg_version }}/bin/psql -U postgres -h 127.0.0.1 -c "SELECT 'CREATE DATABASE cmp_db OWNER admin' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'cmp_db')\gexec" || true
  become_user: root
  environment:
    PGPASSWORD: postgres_password
  register: db_create_result
  until: db_create_result.rc == 0
  retries: 20
  delay: 5
  ignore_errors: yes
  tags: [db_init]
  when: is_db_node
