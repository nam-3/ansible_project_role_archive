---
# Web Role: Nginx + FastAPI App Deployment
# 목적: nginx 설치 → nginx conf 배포 → CMP 앱 파일 복사 → 서비스 시작

# ── 1. 패키지 설치 ──────────────────────────────────────────
- name: Install Nginx
  dnf:
    name: nginx
    state: present

- name: Install Python3 pip
  dnf:
    name: python3-pip
    state: present

# ── 2. 앱 디렉토리 생성 ──────────────────────────────────────
- name: Create Application Directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/cmp_app
    - /opt/cmp_app/templates
    - /opt/h-cmp

# ── 3. CMP 앱 파일 복사 ─────────────────────────────────────
- name: Deploy CMP Application Code
  copy:
    src: cmp_app/main.py
    dest: /opt/cmp_app/main.py
    mode: '0644'

- name: Deploy CMP HTML Templates
  copy:
    src: cmp_app/templates/
    dest: /opt/cmp_app/templates/
    mode: '0644'

# ── 4. Nginx 설정 배포 ───────────────────────────────────────
- name: Deploy Nginx Configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/cmp.conf
    mode: '0644'
  notify: Restart Nginx

- name: Remove default Nginx config (if exists)
  file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: Restart Nginx

# ── 5. Python 의존성 설치 (pip) ──────────────────────────────
- name: Install Python App Dependencies
  pip:
    name:
      - fastapi
      - uvicorn[standard]
      - sqlalchemy
      - python-jose[cryptography]
      - passlib[bcrypt]
      - httpx
      - python-multipart
      - redis
    executable: pip3
    state: present

# ── 6. Systemd 서비스 배포 & 시작 ───────────────────────────
- name: Deploy Systemd Service for CMP App
  template:
    src: archive-web.service.j2
    dest: /etc/systemd/system/archive-web.service
    mode: '0644'
  notify: Restart Archive Web

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Start and Enable Nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: Start and Enable CMP App Service
  service:
    name: archive-web
    state: started
    enabled: yes

# ── 7. WAS 파일 배포 (옵션) ─────────────────────────────────
- name: Create WAS App Directory
  file:
    path: /opt/was_app
    state: directory
    mode: '0755'
  when: was_filename is defined and was_filename != ''

- name: Deploy WAS Application Files
  copy:
    src: "/tmp/was_uploads/{{ was_filename }}/"
    dest: /opt/was_app/
    mode: preserve
  when: was_filename is defined and was_filename != ''
  notify: Restart Archive Web
