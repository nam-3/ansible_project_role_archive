[Unit]
Description=Archive Platform Web API
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/cmp_app
# DB_URL: DB 역할이 함께 배포된 경우에만 설정됨. 없으면 각 서버 환경변수에서 로드
{% if db_user is defined and dblb_vip is defined %}
Environment="DB_URL=postgresql://{{ db_user }}:{{ db_password }}@{{ dblb_vip }}:5432/{{ db_name }}"
{% endif %}
{% if groups['monitoring'] is defined and groups['monitoring'] | length > 0 %}
Environment="PROMETHEUS_HOST={{ hostvars[groups['monitoring'][0]]['ansible_host'] }}"
{% endif %}
{% if groups['gateway'] is defined and groups['gateway'] | length > 0 %}
Environment="REDIS_HOST={{ hostvars[groups['gateway'][0]]['external_ip'] }}"
{% endif %}
# SECRET_KEY and ENCRYPT_KEY will be loaded from system environment
EnvironmentFile=-/etc/environment
EnvironmentFile=-/etc/default/archive-web
ExecStart=/usr/local/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always

[Install]
WantedBy=multi-user.target
