<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>H-CMP | Resource Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 font-black text-xl text-slate-800">
            <i data-lucide="activity" class="text-blue-600"></i>
            <span>My Resources</span>
        </div>
        <a href="/" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-blue-600 transition">
            <i data-lucide="arrow-left"></i> Back to Console
        </a>
    </nav>

    <main class="max-w-7xl mx-auto p-8 fade-in">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Real-time VM Monitoring</h1>
                <p class="text-slate-500 text-sm mt-1">í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì(Admin)ì—ê²Œ í• ë‹¹ëœ VM ìì› í˜„í™©ì…ë‹ˆë‹¤.</p>
            </div>
            <div
                class="flex items-center gap-2 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                <span class="relative flex h-2 w-2"><span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                        class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span>
                Live Updating (5s)
            </div>
        </div>

        <div id="vm-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </main>
    <script>
        // ì•„ì´ì½˜ ì´ˆê¸°í™”
        lucide.createIcons();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë  ë¡œì§ ì˜ˆì‹œ
        // fetchPendingUsers(); 
    </script>
</body>

</html>

<script>
    lucide.createIcons();

    // [ìˆ˜ì • 1] ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬ ê°ì²´ ì¶”ê°€ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
    const chartRegistry = {};

    async function fetchResources() {
        const token = localStorage.getItem('token');
        console.log("ğŸ”‘ í˜„ì¬ ë°œì†¡í•˜ë ¤ëŠ” í† í°:", token);

        if (!token) {
            console.warn("ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            location.href = '/';
            return;
        }

        try {
            const res = await fetch('/api/monitoring/my-resources', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // [í•µì‹¬] ì¸ì¦ í—¤ë” ì¶”ê°€
                }
            });

            if (res.status === 401) {
                console.error("ì¸ì¦ ì‹¤íŒ¨: ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                // location.href = '/login'; // í•„ìš” ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                return;
            }

            const data = await res.json();
            renderCards(data);
        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
        }
    }

    // [ìˆ˜ì • 2] ë Œë”ë§ ë¡œì§ ìµœì í™” (Diff ì•Œê³ ë¦¬ì¦˜ ì ìš©)
    function renderCards(vms) {
        const grid = document.getElementById('vm-grid');

        // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì²˜ë¦¬
        if (vms.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400">í• ë‹¹ëœ VMì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            // ê¸°ì¡´ ì°¨íŠ¸ ë©”ëª¨ë¦¬ í•´ì œ
            Object.keys(chartRegistry).forEach(key => {
                if (chartRegistry[key].cpu) chartRegistry[key].cpu.destroy();
                if (chartRegistry[key].mem) chartRegistry[key].mem.destroy();
                delete chartRegistry[key];
            });
            return;
        }

        // 1. ì‚¬ë¼ì§„ VM ì •ë¦¬ (Garbage Collection)
        const currentVmNames = new Set(vms.map(vm => vm.vm_name));
        Object.keys(chartRegistry).forEach(vmName => {
            if (!currentVmNames.has(vmName)) {
                // ì°¨íŠ¸ íŒŒê´´ (ë©”ëª¨ë¦¬ í•´ì œ)
                chartRegistry[vmName].cpu.destroy();
                chartRegistry[vmName].mem.destroy();
                delete chartRegistry[vmName];
                // DOM ì œê±°
                const card = document.getElementById(`card-${vmName}`);
                if (card) card.remove();
            }
        });

        // 2. ì¹´ë“œ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
        vms.forEach((vm) => {
            // IDì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê³µë°± ë“±ì„ ì²˜ë¦¬
            const safeName = vm.vm_name.replace(/\s+/g, '-');
            const cardId = `card-${vm.vm_name}`;

            if (chartRegistry[vm.vm_name]) {
                // [Update] ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì°¨íŠ¸ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (DOM ì¬ìƒì„± X)
                updateCard(vm, safeName);
            } else {
                // [Create] ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                createCard(grid, vm, safeName, cardId);
            }
        });

        lucide.createIcons();
    }

    // ì‹ ê·œ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createCard(grid, vm, safeName, cardId) {
        const card = document.createElement('div');
        card.id = cardId;
        card.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition fade-in";
        card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest bg-blue-50 px-2 py-0.5 rounded">${vm.project_name}</span>
                        <h3 class="text-lg font-bold text-slate-800 mt-1">${vm.vm_name}</h3>
                        <p class="text-xs text-slate-400 font-mono">${vm.ip_address}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.open('/terminal?ip=${vm.ip_address}', '_blank')" class="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg transition shadow-sm" title="Web Terminal Connection">
                            <i data-lucide="terminal-square" class="w-5 h-5"></i>
                        </button>
                        <div class="bg-green-100 text-green-700 p-2 rounded-lg"><i data-lucide="server" class="w-5 h-5"></i></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="text-center">
                        <canvas id="cpu-chart-${safeName}" height="100"></canvas>
                        <p class="text-xs font-bold text-slate-500 mt-2">CPU</p>
                        <p id="cpu-text-${safeName}" class="text-lg font-black text-slate-800">${vm.cpu_usage}%</p>
                    </div>
                    <div class="text-center">
                        <canvas id="mem-chart-${safeName}" height="100"></canvas>
                        <p class="text-xs font-bold text-slate-500 mt-2">Memory</p>
                        <p id="mem-text-${safeName}" class="text-lg font-black text-slate-800">${vm.memory_usage}%</p>
                    </div>
                    <div class="text-center">
                        <canvas id="disk-chart-${safeName}" height="100"></canvas>
                        <p class="text-xs font-bold text-slate-500 mt-2">Disk</p>
                        <p id="disk-text-${safeName}" class="text-lg font-black text-slate-800">${vm.disk_usage}%</p>
                    </div>
                </div>
            `;
        grid.appendChild(card);

        // ì°¨íŠ¸ ìƒì„± í›„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë“±ë¡
        chartRegistry[vm.vm_name] = {
            cpu: drawChart(`cpu-chart-${safeName}`, vm.cpu_usage, '#3b82f6'),
            mem: drawChart(`mem-chart-${safeName}`, vm.memory_usage, '#8b5cf6'),
            disk: drawChart(`disk-chart-${safeName}`, vm.disk_usage, '#10b981')
        };
    }

    // ê¸°ì¡´ ì¹´ë“œ ë°ì´í„° ê°±ì‹  í•¨ìˆ˜
    function updateCard(vm, safeName) {
        // í…ìŠ¤íŠ¸ ê°±ì‹ 
        document.getElementById(`cpu-text-${safeName}`).innerText = `${vm.cpu_usage}%`;
        document.getElementById(`mem-text-${safeName}`).innerText = `${vm.memory_usage}%`;
        document.getElementById(`disk-text-${safeName}`).innerText = `${vm.disk_usage}%`;

        // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
        const charts = chartRegistry[vm.vm_name];
        charts.cpu.data.datasets[0].data = [vm.cpu_usage, 100 - vm.cpu_usage];
        charts.cpu.update();

        charts.mem.data.datasets[0].data = [vm.memory_usage, 100 - vm.memory_usage];
        charts.mem.update();

        charts.disk.data.datasets[0].data = [vm.disk_usage, 100 - vm.disk_usage];
        charts.disk.update();
    }

    // [ìˆ˜ì • 3] ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•˜ë„ë¡ ë³€ê²½
    function drawChart(canvasId, value, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Used', 'Free'],
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [color, '#f1f5f9'],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { duration: 0 }
            }
        });
    }

    fetchResources();
    setInterval(fetchResources, 5000);
</script>
</body>

</html>